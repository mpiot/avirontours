name: Tests

on:
    push:
        branches: [ main, develop ]
    pull_request:
        types:
            - opened
            - reopened
            - synchronize
            - ready_for_review

env:
    PHPUNIT_FLAGS: "-v --coverage-clover coverage-report.xml --log-junit tests-report.xml"
    FOUNDRY_RESET_MODE: "migrate"
    SYMFONY_DEPRECATIONS_HELPER: "disabled"

jobs:
    test:
        name: Tests
        runs-on: ubuntu-latest
        continue-on-error: false

        if: github.event.pull_request.draft == false

        env:
            DATABASE_URL: "pgsql://user:password@localhost:5432/main"

        services:
            postgres:
                image: postgres:14
                env:
                    POSTGRES_USER: user
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: main
                ports:
                    - 5432:5432
                options: --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=10

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Install PHP
              uses: shivammathur/setup-php@v2
              with:
                  coverage: pcov
                  ini-values: date.timezone = Europe/Paris
                  php-version: '8.1'
                  tools: composer:v2
                  extensions: curl, intl, mbstring, pdo_pgsql, xml, zip

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "::set-output name=dir::$(composer config cache-files-dir)"

            - uses: actions/cache@v2
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Composer install
              run: composer install --no-interaction --no-progress

            - name: Install Node
              uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: Install Yarn
              run: npm install -g yarn

            - name: Setup Yarn cache
              uses: actions/setup-node@v2
              with:
                  cache: 'yarn'

            - name: Install node modules
              run: yarn install

            - name: Build assets
              run: yarn build

            - name: Run tests
              run: vendor/bin/paratest --runner WrapperRunner ${{ env.PHPUNIT_FLAGS }}

            - name: Upload PHPUnit Reports
              uses: actions/upload-artifact@v2
              with:
                  name: phpunit-reports
                  path: |
                      coverage-report.xml
                      tests-report.xml
                  retention-days: 1

    sonarcloud:
        name: SonarCloud
        runs-on: ubuntu-latest

        if: github.event.pull_request.draft == false
        needs: test

        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

            - name: Download PHPUnit Reports
              uses: actions/download-artifact@v2
              with:
                  name: phpunit-reports

            - name: Change Paths from PHPUnit reports
              run: sed -i 's/\/home\/runner\/work\/avirontours\/avirontours/\/github\/workspace/g' coverage-report.xml

            - name: SonarCloud Scan
              uses: SonarSource/sonarcloud-github-action@master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
